---
title: ANOVA
order: 8
date: 2025-02-28
category:
  - Statistics
tag:
  - Study Note
---
<!-- # ANOVA (Analysis Of Variance) -->

<!-- more -->

### Hypothesis
- $H_0$: 各組的均值相等，$\mu_1 = \mu_2 = \dots = \mu_k, k \geq 3$。
- $H_A$: 至少有一組均值不同，$\mu_i \neq \mu_j$ for some i, j。

### 計算變異來源的平方和（Sum of Squares, SS）
   - $SS_{total}$: 整體數據的變異。
     $$
     SS_{total} = \sum_{i=1}^{k} \sum_{j=1}^{n_i} \left( Y_{ij} - \bar{Y} \right)^2 \sim \sigma^2\chi^2_{N-1}
     $$
   - $SS_{between}$: 各組平均與整體平均之間的變異。
     $$
     SS_{between} = \sum_{i=1}^{k} n_i \left( \bar{Y}_i - \bar{Y} \right)^2 \sim \sigma^2 \chi^2_{k-1}
     $$
   - $SS_{within}$: 各組內的變異。
     $$
     SS_{within} = \sum_{i=1}^{k} (n_i-1)\sum_{j=1}^{n_i} \left( Y_{ij} - \bar{Y}_i \right)^2 \sim \sigma^2\chi^2_{N-k}
     $$
- $n_i$ 是各組的樣本數。
- $N = \sum_{i=1}^{k} n_i$ 是總樣本數。
- 組內平均：
    $$
       \bar{Y_i} = \frac{1}{n_i} \sum_{j=1}^{n_i} Y_{ij}
    $$
- 總平均：
    $$
       \bar{Y} = \frac{1}{N} \sum_{i=1}^{k} \sum_{j=1}^{n_i} Y_{ij}
    $$
- 注意：$SS_{total} = SS_{between} + SS_{within}$。

### Mean Square (MS)

$$
MS_{between} = \frac{SS_{between}}{df_{between}}，\quad MS_{within} = \frac{SS_{within}}{df_{within}}
$$


### 檢定統計量 F
$$
F = \frac{MS_{between}}{MS_{within}} \sim F_{k-1, N-k}
$$

### p - value

$$
p = P(F_{k-1, N-k} > F)
$$

### 假設條件和穩健性
- 數據來自常態分佈。$Y_{i, j} \sim N(\mu_i, \sigma^2)$
- 各組的變異數相等。
- 各觀測值相互獨立。
- 常態性不是絕對關鍵的。只有當樣本量較小且分布極度長尾或傾斜時，才是一個嚴重的問題。
- 組內和組間的獨立性是關鍵的。如果不獨立，應使用不同的分析方法。
- ANOVA 工具對異常值不具抗性。
- 各組間的變異數相等是一個關鍵的假設。

### Residual Analysis

在 ANOVA 中，**Residual Analysis（殘差分析）** 是評估模型適配性的重要步驟，用於檢查模型假設是否成立，包括正態性、方差同質性和獨立性。

#### **1. 定義殘差**
在 ANOVA 中，殘差 $e_{ij}$ 表示實際觀測值與模型預測值的差異：
$$
e_{ij} = Y_{ij} - \bar{Y}_i
$$
其中：
- $Y_{ij}$：第 $i$ 組的第 $j$ 個觀測值。
- $\bar{Y}_i$：第 $i$ 組的均值（模型預測值），計算公式：
  $$
  \bar{Y}_i = \frac{1}{n_i} \sum_{j=1}^{n_i} Y_{ij}
  $$
  $n_i$ 是第 $i$ 組的樣本數。


#### **2. 計算殘差平方和（Residual Sum of Squares, RSS）**
殘差平方和 $SS_{\text{within}}$ 是 ANOVA 中組內變異的一部分，計算公式為：
$$
SS_{\text{within}} = \sum_{i=1}^k \sum_{j=1}^{n_i} e_{ij}^2
$$
即所有殘差的平方和，用於量化模型未能解釋的變異。


#### **4. 分析步驟**

1. 正態性檢查
- **方法**：檢查殘差是否來自正態分佈。
- **數學測試**：
  - 使用 **標準化殘差**：
    $$
    z_{ij} = \frac{e_{ij}}{\hat{\sigma}_{\text{within}}}
    $$
    其中 $\hat{\sigma}_{\text{within}}$ 是組內標準差的估計值：
    $$
    \hat{\sigma}_{\text{within}} = \sqrt{\frac{SS_{\text{within}}}{df_{\text{within}}}}
    $$
    $df_{\text{within}} = N - k$，$N$ 是總觀測數，$k$ 是組數。
  - 檢查 $z_{ij}$ 的分佈是否接近標準正態分佈 $N(0, 1)$。
- **直觀方法**：
  - 繪製直方圖檢查分佈形狀。
  - 使用正態 Q-Q 圖檢查殘差分佈是否沿對角線排列。
2. 方差同質性檢查
- **目標**：檢查不同組的殘差變異數是否相同。
- **檢定方法**：
  - 使用 Levene 檢定或 Bartlett 檢定：
    $$
    F = \frac{SS_{between}}{SS_{within}}
    $$
    如果 $F$ 值顯著，則拒絕方差同質性假設。
3. 獨立性檢查
- **目標**：檢查殘差之間是否存在相關性。
- **數學檢驗**：
  - 如果數據按時間或空間排列，計算殘差的自相關係數：
    $$
    \rho = \frac{\sum_{t=1}^{T-1} (e_t - \bar{e})(e_{t+1} - \bar{e})}{\sum_{t=1}^{T} (e_t - \bar{e})^2}
    $$
    $\rho$ 為自相關係數。
- **直觀方法**：
  - 繪製殘差的時間序列圖或空間散佈圖，檢查是否存在趨勢。



#### **5. 解釋與改進

1. **正態性問題**：若殘差偏離正態分佈，可考慮對數據進行轉換（如對數或平方根變換）。
2. **方差異質性**：若方差不相等，可採用穩健 ANOVA（如 Welch’s ANOVA）。
3. **殘差相關性**：若存在相關性，可能需要引入自相關模型（如 ARIMA）或使用混合效應模型。



#### **總結公式**
1. 殘差定義：
   $$
   e_{ij} = Y_{ij} - \hat{Y}_i
   $$
2. 殘差平方和：
   $$
   SS_{\text{within}} = \sum_{i=1}^k \sum_{j=1}^{n_i} e_{ij}^2
   $$
3. 標準化殘差：
   $$
   z_{ij} = \frac{e_{ij}}{\hat{\sigma}_{\text{within}}}
   $$
4. 方差同質性檢查：
   $$
   \text{Var}_i(e_{ij}) = \frac{1}{n_i - 1} \sum_{j=1}^{n_i} e_{ij}^2
   $$


## 非參數ANOVA

### **非參數ANOVA的介紹**
非參數ANOVA不依賴常態分佈假設，適合樣本量小或樣本不符合正態性的情況。主要方法是 **Kruskal-Wallis檢定**，它基於秩轉換來比較多組中位數是否相等。

### **非參數ANOVA的步驟**

1. **設立假設**
   - **零假設 $H_0$**：所有組的中位數相等。
   - **對立假設 $H_A$**：至少有一組的中位數不同。
2. **準備數據**
   - 收集數據並將所有觀測值合併為一組。
   - 將數據按大小排序，為每個值分配秩（小的值秩數小）。
3. **計算各組秩的總和**
   - 計算每組的秩和 $R_i$。
   - 記錄每組樣本數 $n_i$。
4. **計算檢定統計量 $H$**
   - 使用公式：
     $$
     H = \frac{12}{N(N+1)} \sum_{i=1}^k \frac{R_i^2}{n_i} - 3(N+1)
     $$
     其中：
     - $N$ 是所有組的總樣本數。
     - $k$ 是組數。
     - $R_i$ 是第 $i$ 組的秩和。
     - $n_i$ 是第 $i$ 組的樣本數。
5. **調整統計量（如有需要）**
   - 若有秩並列（ties），需調整公式：
     $$
     H = \frac{H_{\text{原始}}}{1 - \frac{\sum_{t} (t^3 - t)}{N^3 - N}}
     $$
     其中 $t$ 是每個並列組中的秩數量。
6. **比較檢定統計量與臨界值**
   - $H$ 近似服從 $\chi^2$ 分佈，自由度為 $k - 1$。
   - 查表或使用軟件計算臨界值 $\chi^2_{\text{critical}}$ 或 $p$ 值。
7. **做出結論**
   - 若 $H > \chi^2_{\text{critical}}$ 或 $p$ 值小於顯著水平 $\alpha$，拒絕 $H_0$。
   - 否則，接受 $H_0$。

### **公式總結**

1. **檢定統計量 $H$:**
   $$
   H = \frac{12}{N(N+1)} \sum_{i=1}^k \frac{R_i^2}{n_i} - 3(N+1)
   $$
2. **秩並列調整公式：**
   $$
   \text{調整因子} = 1 - \frac{\sum_{t} (t^3 - t)}{N^3 - N}
   $$
3. **自由度：**
   $$
   df = k - 1
   $$

### **注意事項**
- **非參數方法的假設：**
  - 各組數據的分佈形狀相同。
  - 各組數據獨立。
- 如果檢定顯著，需進行事後檢定（如 Dunn 檢定）來確定哪些組之間有差異。


<!-- ### **非參數ANOVA的步驟**

1. **設立假設**
   - **零假設 \( H_0 \)**：所有組的中位數相等。
   - **對立假設 \( H_A \)**：至少有一組的中位數不同。

2. **準備數據**
   - 收集數據並將所有觀測值合併為一組。
   - 將數據按大小排序，為每個值分配秩（小的值秩數小）。

3. **計算各組秩的總和**
   - 計算每組的秩和 \( R_i \)。
   - 記錄每組樣本數 \( n_i \)。

4. **計算檢定統計量 \( H \)**
   - 使用公式：
     $$
     H = \frac{12}{N(N+1)} \sum_{i=1}^k \frac{R_i^2}{n_i} - 3(N+1)
     $$
     其中：
     - \( N \) 是所有組的總樣本數。
     - \( k \) 是組數。
     - \( R_i \) 是第 \( i \) 組的秩和。
     - \( n_i \) 是第 \( i \) 組的樣本數。

5. **調整統計量（如有需要）**
   - 若有秩並列（ties），需調整公式：
     $$
     H = \frac{H_{原始}}{1 - \frac{\sum_{t} (t^3 - t)}{N^3 - N}}
     $$
     其中 \( t \) 是每個並列組中的秩數量。

6. **比較檢定統計量與臨界值**
   - \( H \) 近似服從 \( \chi^2 \) 分佈，自由度為 \( k - 1 \)。
   - 查表或使用軟件計算臨界值 \( \chi^2_{critical} \) 或 p 值。

7. **做出結論**
   - 若 \( H > \chi^2_{critical} \) 或 p 值小於顯著水平 \( \alpha \)，拒絕 \( H_0 \)。
   - 否則，接受 \( H_0 \)。



### **公式總結**

1. **檢定統計量 \( H \):**
   $$
   H = \frac{12}{N(N+1)} \sum_{i=1}^k \frac{R_i^2}{n_i} - 3(N+1)
   $$
2. **秩並列調整公式：**
   $$
   調整因子 = 1 - \frac{\sum_{t} (t^3 - t)}{N^3 - N}
   $$
3. **自由度：**
   $$
   df = k - 1
   $$



### **注意事項**
- **非參數方法的假設：**
  - 各組數據的分佈形狀相同。
  - 各組數據獨立。
- 如果檢定顯著，需進行事後檢定（如Dunn檢定）來確定哪些組之間有差異。



 -->